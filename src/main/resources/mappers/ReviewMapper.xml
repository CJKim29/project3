<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.githrd.project3.dao.ReviewMapper">

  <!-- 전체조회 -->
  <select id="selectReviewList" resultType="review">
		SELECT r.review_idx, r.review_title, r.review_content,
           r.mem_nickname, r.review_regdate, r.review_readhit,
           rs.review_score_point, m.mem_filename
    FROM review r
    JOIN member m ON r.mem_idx = m.mem_idx
    LEFT JOIN review_score rs ON r.review_idx = rs.review_idx
    WHERE r.performance_idx = #{performance_idx}
    ORDER BY r.review_idx desc;
  </select>

  <!-- 리뷰 작성(insert) -->
  <!-- review_idx 받아오기 위해 useGenerateKeys와 keyProperty사용 -->
  <insert id="review_insert" parameterType="review"  useGeneratedKeys="true" keyProperty="review_idx">
     insert into review values(null,
                               #{ mem_idx },
                               #{ performance_idx },
                               #{ review_title },
                               #{ review_content },
                               #{ mem_nickname },
                               now(),
                               default
                               );
    
  </insert>
  <!-- 평점 insert -->
  <insert id="insertReviewScore" parameterType="review_score">
      insert into review_score values(null,
                                      #{ mem_idx },
                                      #{ performance_idx },
                                      #{ review_idx },
                                      #{ review_score_point }
                                      );
  </insert>

  <!-- 유저가 이미 조회수를 증가시킨 경우를 체크 -->
    <select id="checkUserReadhit" parameterType="map" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_review_readhit
        WHERE mem_idx = #{ mem_idx }
        AND review_idx = #{ review_idx }
    </select>

    <!-- 조회수 증가 -->
    <update id="incrementReadhit" parameterType="int">
        UPDATE review
        SET review_readhit = review_readhit + 1
        WHERE review_idx = #{ review_idx }
    </update>

    <!-- 유저의 조회수 증가 기록 추가 -->
    <insert id="insertUserReadhit" parameterType="map">
        INSERT INTO user_review_readhit (mem_idx, review_idx)
        VALUES (#{ mem_idx }, #{ review_idx })
    </insert>
</mapper>